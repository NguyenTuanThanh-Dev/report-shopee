<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ph·∫ßn m·ªÅm T√≠nh Doanh S·ªë Shopee - VQF</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <style>
    /* Reset & c∆° b·∫£n */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0;
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      background: #f5f7fa;
    }

    /* Menu tr√°i */
    #sidebar {
      width: 250px;
      background-color: #004080;
      color: white;
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }
    #sidebar.collapsed {
      width: 60px;
    }
    #sidebar .logo {
      padding: 20px;
      font-weight: bold;
      font-size: 24px;
      text-align: center;
      border-bottom: 1px solid rgba(255,255,255,0.3);
      user-select: none;
    }
    #sidebar.collapsed .logo {
      font-size: 18px;
      padding: 20px 10px;
    }

    /* Menu item */
    #sidebar nav {
      flex: 1;
      padding: 10px 0;
    }
    #sidebar nav button {
      width: 100%;
      background: transparent;
      border: none;
      color: white;
      font-size: 18px;
      padding: 15px 20px;
      text-align: left;
      cursor: pointer;
      border-left: 4px solid transparent;
      transition: background-color 0.2s, border-left-color 0.2s;
    }
    #sidebar nav button:hover,
    #sidebar nav button.active {
      background-color: #0059b3;
      border-left-color: #ffd700;
    }
    #sidebar.collapsed nav button span.text {
      display: none;
    }

    /* Toggle button */
    #toggleSidebar {
      background: #003366;
      color: white;
      border: none;
      cursor: pointer;
      padding: 10px;
      font-size: 20px;
      user-select: none;
      border-top: 1px solid rgba(255,255,255,0.3);
    }
    #sidebar.collapsed #toggleSidebar {
      text-align: center;
      font-size: 24px;
      padding: 10px 0;
    }

    /* Main content */
    #mainContent {
      flex: 1;
      padding: 25px 40px;
      overflow-y: auto;
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #003366;
    }

    label {
      font-weight: 600;
      margin-right: 15px;
    }

    select, input[type="file"] {
      font-size: 16px;
      padding: 7px 10px;
      margin-bottom: 15px;
    }

    button.import-btn {
      margin-right: 10px;
      padding: 10px 18px;
      font-size: 16px;
      background-color: #004080;
      border: none;
      color: white;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    button.import-btn:hover {
      background-color: #0059b3;
    }

    /* B·∫£ng */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
      box-shadow: 0 0 10px rgba(0,0,0,0.05);
      background: white;
    }
    th, td {
      padding: 10px 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background-color: #004080;
      color: white;
      user-select: none;
    }
    tbody tr:hover {
      background-color: #f0f7ff;
    }

    /* B·∫£ng hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß t·∫•t c·∫£ d·ªØ li·ªáu */
    #mainContent > div.table-container {
      margin-bottom: 30px;
      border-radius: 6px;
      box-shadow: inset 0 0 8px #ddd;
    }

    /* Toast message */
    #toastContainer {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 300px;
      z-index: 10000;
      font-family: Arial, sans-serif;
    }
    .toast {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #4CAF50; /* m·∫∑c ƒë·ªãnh th√†nh c√¥ng */
      color: white;
      padding: 15px 20px;
      margin-top: 10px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      animation: slideIn 0.5s ease forwards;
      user-select: none;
    }
    .toast.error {
      background-color: #f44336;
    }
    .toast .close-btn {
      cursor: pointer;
      font-weight: bold;
      margin-left: 15px;
      font-size: 18px;
      line-height: 18px;
    }

    @keyframes slideIn {
      from {opacity: 0; transform: translateX(100%);}
      to {opacity: 1; transform: translateX(0);}
    }

    /* Highlight b·∫£ng t·ªïng h·ª£p Tiktok */
    #tiktokTotalSummaryTable tr, #tiktokTotalSummaryTable th, #tiktokTotalSummaryTable td {
      background-color: #004080 !important;
      color: white;
    }
    /* Highlight d√≤ng duplicate Order ID trong b·∫£ng chi ti·∫øt Tiktok */
    #tiktokSummaryTable tr.duplicate-order {
      background-color: #FFB6C1 !important;
    }
  </style>
</head>
<body>

  <aside id="sidebar">
    <div class="logo">VQF</div>
    <nav>
      <button id="btnTinhDoanhSoShopee" class="active"><span class="text">T√≠nh Doanh S·ªë Shopee</span></button>
      <button id="btnTinhDoanhThuTiktok"><span class="text">T√≠nh Doanh s·ªë Tiktok</span></button>
      <button id="btnDashboardAffTiktok"><span class="text">Dashboard AFF Tiktok</span></button>
    </nav>
    <button id="toggleSidebar" title="·∫®n/Hi·ªán menu">‚Øà</button>
  </aside>

  <main id="mainContent">
    <h1>Ph·∫ßn m·ªÅm T√≠nh Doanh S·ªë Shopee - VQF</h1>

    <div id="tinhDoanhSoShopeeSection">
      <label for="shopSelect">Ch·ªçn Shop:</label>
      <select id="shopSelect">
        <option value="Elwyn">Elwyn</option>
        <option value="Melina">Melina</option>
        <option value="caboxin.official">caboxin.official</option>
        <option value="chipbongjp">chipbongjp</option>
        <option value="dandongkhe">dandongkhe</option>
        <option value="dungdungnguyen92.cg_hd">dungdungnguyen92.cg_hd</option>
        <option value="genjeann">genjeann</option>
        <option value="melajeans">melajeans</option>
        <option value="tdfashion_vnxk">tdfashion_vnxk</option>
        <option value="tdmen_vnxk">tdmen_vnxk</option>
        <option value="thuyvoi">thuyvoi</option>
        <option value="teemeejean">teemeejean</option>
        <option value="trendjeanss">trendjeanss</option>
        <option value="nhajean">nhajean</option>
        <option value="lilianastoree">lilianastoree</option>
        <option value="nirajean">nirajean</option>
        <option value="jeantini">jeantini</option>
        <option value="tdkiddo">tdkiddo</option>
      </select>

      <label for="loaiDonSelect" style="margin-left:30px;">Ch·ªçn Lo·∫°i ƒê∆°n:</label>
      <select id="loaiDonSelect">
        <option value="ƒê∆°n th·∫≠t">ƒê∆°n th·∫≠t</option>
        <option value="ƒê∆°n ·∫£o">ƒê∆°n ·∫£o</option>
      </select>

      <br />

      <input type="file" id="fileInput" accept=".xls,.xlsx,.csv" />
      <button class="import-btn" id="importBtn">Import ƒê∆°n</button>
      <input type="file" id="affFileInput" accept=".xls,.xlsx,.csv" style="margin-left:20px;" />
      <button class="import-btn" id="importAffBtn">Import AFF</button>
      <button class="import-btn" id="debugBtn" style="margin-left:20px; background-color: #ff9800;">Debug Info</button>

      <!-- B·∫£ng t·ªïng h·ª£p -->
      <h2 style="display:flex;align-items:center;gap:8px;">
        B·∫£ng T√≠nh T·ªïng H·ª£p Doanh S·ªë
        <button id="toggleSummaryTable" style="background:none;border:none;font-size:20px;cursor:pointer;">‚ñº</button>
      </h2>
      <div class="table-container" id="summaryTableContainer">
        <table id="summaryTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>Doanh s·ªë (ƒê∆°n th·∫≠t)</th>
              <th>Doanh s·ªë th·ª±c t·∫ø</th>
              <th>Doanh s·ªë Ho√†n/H·ªßy</th>
              <th>Doanh s·ªë ƒê∆°n H·ªßy</th>
              <th>Doanh s·ªë ƒê∆°n Ho√†n</th>
              <th>T·ª∑ l·ªá H·ªßy (%)</th>
              <th>T·ª∑ l·ªá Ho√†n (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- B·∫£ng Chi ph√≠ s√†n -->
      <h2 style="display:flex;align-items:center;gap:8px;">
        B·∫£ng Chi ph√≠ S√†n
        <button id="togglePlatformCostTable" style="background:none;border:none;font-size:20px;cursor:pointer;">‚ñº</button>
      </h2>
      <div class="table-container" id="platformCostTableContainer">
        <table id="platformCostTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>S·ªë ƒë∆°n h√†ng th·ª±c t·∫ø</th>
              <th>Ph√≠ c·ªë ƒë·ªãnh</th>
              <th>Ph√≠ d·ªãch v·ª•</th>
              <th>Ph√≠ thanh to√°n</th>
              <th>Ph√≠ Pi Ship</th>
              <th>T·ªïng Chi ph√≠ S√†n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- B·∫£ng Chi ph√≠ t·ªïng h·ª£p -->
      <h2 style="display:flex;align-items:center;gap:8px;">
        B·∫£ng Chi ph√≠ T·ªïng h·ª£p
        <button id="toggleCostSummaryTable" style="background:none;border:none;font-size:20px;cursor:pointer;">‚ñº</button>
      </h2>
      <div class="table-container" id="costSummaryTableContainer">
        <table id="costSummaryTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>M√£ gi·∫£m gi√° c·ªßa Shop</th>
              <th>Combo c·ªßa Shop</th>
              <th>Gi·∫£m gi√° Combo Gh√©p</th>
              <th>Chi ph√≠ FLsale</th>
              <th>Chi ph√≠ AFF</th>
              <th>T·ªïng Chi ph√≠</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- B·∫£ng danh s√°ch ƒë∆°n h√†ng -->
      <h2 style="display:flex;align-items:center;gap:8px;">
        Danh S√°ch ƒê∆°n H√†ng
        <button id="toggleOrdersTable" style="background:none;border:none;font-size:20px;cursor:pointer;">‚ñº</button>
      </h2>
      <div style="margin-bottom:10px;" id="ordersTableFilterBar">
        <label for="giaUuDaiFilter">L·ªçc theo Gi√° ∆∞u ƒë√£i:</label>
        <select id="giaUuDaiFilter"></select>
        <input type="number" min="0" id="batchFlSaleInput" placeholder="Nh·∫≠p Chi ph√≠ FLsale" style="width:120px; margin-left:10px;">
        <button class="import-btn" id="applyBatchFlSaleBtn">√Åp d·ª•ng h√†ng lo·∫°t</button>
        <button class="import-btn" id="saveFlSaleBtn">L∆∞u Chi ph√≠ FLsale</button>
      </div>
      <div class="table-container" id="ordersTableContainer">
        <table id="ordersTable">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllOrders"></th>
              <th>Shop</th>
              <th>M√£ ƒê∆°n H√†ng</th>
              <th>M√£ V·∫≠n ƒê∆°n</th>
              <th>Lo·∫°i ƒê∆°n</th>
              <th>Tr·∫°ng Th√°i</th>
              <th>Tr·∫°ng Th√°i Tr·∫£ h√†ng/Ho√†n ti·ªÅn</th>
              <th>Gi√° ∆∞u ƒë√£i</th>
              <th>Doanh S·ªë</th>
              <th>Chi ph√≠ FLsale</th>
              <th>Chi ph√≠ Combo gh√©p</th>
            </tr>
            <tr id="ordersTableSearchRow">
              <th><input type="text" class="search-col" data-col="shop" style="width:90px"></th>
              <th><input type="text" class="search-col" data-col="maDonHang" style="width:110px"></th>
              <th><input type="text" class="search-col" data-col="maVanDon" style="width:110px"></th>
              <th><input type="text" class="search-col" data-col="loaiDon" style="width:90px"></th>
              <th><input type="text" class="search-col" data-col="trangThai" style="width:110px"></th>
              <th><input type="text" class="search-col" data-col="trangThaiTraHangHoanTien" style="width:140px"></th>
              <th><input type="text" class="search-col" data-col="giaUuDai" style="width:90px"></th>
              <th><input type="text" class="search-col" data-col="doanhSo" style="width:90px"></th>
              <th><input type="text" class="search-col" data-col="flSaleCost" style="width:90px"></th>
              <th><input type="text" class="search-col" data-col="comboCost" style="width:90px"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <!-- B·∫£ng d·ªØ li·ªáu AFF -->
      <h2 style="margin-top:30px;">B·∫£ng D·ªØ Li·ªáu AFF</h2>
      <div class="table-container" id="affTableContainer">
        <table id="affTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>M√£ ƒë∆°n h√†ng</th>
              <th>Tr·∫°ng th√°i ƒë∆°n h√†ng</th>
              <th>Tr·∫°ng th√°i gian l·∫≠n</th>
              <th>T√†i kho·∫£n Ti·∫øp th·ªã li√™n k·∫øt</th>
              <th>MCN ƒë∆∞·ª£c li√™n k·∫øt</th>
              <th>K√™nh</th>
              <th>Chi ph√≠(‚Ç´)</th>
              <th>Tr·∫°ng th√°i kh·∫•u tr·ª´</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>


    </div>
    <div id="tinhDoanhThuTiktokSection" style="display:none;">
      <label for="shopSelectTiktok">Ch·ªçn Shop:</label>
      <select id="shopSelectTiktok">
        <option value="Elwyn">Elwyn</option>
        <option value="Melina">Melina</option>
        <option value="caboxin.official">caboxin.official</option>
        <option value="chipbongjp">chipbongjp</option>
        <option value="dandongkhe">dandongkhe</option>
        <option value="dungdungnguyen92.cg_hd">dungdungnguyen92.cg_hd</option>
        <option value="genjeann">genjeann</option>
        <option value="melajeans">melajeans</option>
        <option value="tdfashion_vnxk">tdfashion_vnxk</option>
        <option value="tdmen_vnxk">tdmen_vnxk</option>
        <option value="thuyvoi">thuyvoi</option>
        <option value="teemeejean">teemeejean</option>
        <option value="trendjeanss">trendjeanss</option>
        <option value="nhajean">nhajean</option>
        <option value="lilianastoree">lilianastoree</option>
        <option value="nirajean">nirajean</option>
        <option value="jeantini">jeantini</option>
        <option value="tdkiddo">tdkiddo</option>
      </select>
      <label for="loaiDonSelectTiktok" style="margin-left:30px;">Ch·ªçn Lo·∫°i ƒê∆°n:</label>
      <select id="loaiDonSelectTiktok">
        <option value="ƒê∆°n th·∫≠t">ƒê∆°n th·∫≠t</option>
        <option value="ƒê∆°n ·∫£o">ƒê∆°n ·∫£o</option>
      </select>
      <br />
      <input type="file" id="fileInputTiktok" accept=".xls,.xlsx,.csv" />
      <button class="import-btn" id="importBtnTiktok">Import ƒê∆°n Tiktok</button>
      <input type="file" id="affFileInputTiktok" accept=".xls,.xlsx,.csv" style="margin-left:20px;" />
      <button class="import-btn" id="importAffBtnTiktok">Import AFF Tiktok</button>
      <div class="table-container" id="tiktokSummaryTableContainer" style="margin-top:30px;">
        <h2 style="margin-top:30px;">B·∫£ng T√≠nh T·ªïng H·ª£p Doanh S·ªë</h2>
        <table id="tiktokTotalSummaryTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>Doanh s·ªë (ƒê∆°n th·∫≠t)</th>
              <th>Doanh s·ªë th·ª±c t·∫ø</th>
              <th>Doanh s·ªë Ho√†n/H·ªßy</th>
              <th>Doanh s·ªë ƒê∆°n H·ªßy</th>
              <th>Doanh s·ªë ƒê∆°n Ho√†n</th>
              <th>T·ª∑ l·ªá H·ªßy (%)</th>
              <th>T·ª∑ l·ªá Ho√†n (%)</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <h2 style="margin-top:30px;">B·∫£ng Chi ph√≠ T·ªïng h·ª£p Tiktok</h2>
        <table id="tiktokCostSummaryTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>T·ªïng chi ph√≠ Combo gh√©p</th>
              <th>T·ªïng chi ph√≠ AFF</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <h2 style="margin-top:30px;">Chi ti·∫øt ƒë∆°n h√†ng Tiktok</h2>
        <table id="tiktokSummaryTable">
          <thead>
            <tr>
              <th>Shop</th>
              <th>Order ID</th>
              <th>SKU s·∫£n ph·∫©m</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Lo·∫°i tr·∫£ h√†ng/h·ªßy</th>
              <th>Gi√°</th>
              <th>Gi·∫£m gi√° Tiktok</th>
              <th>Gi·∫£m gi√° Shop</th>
              <th>Doanh s·ªë</th>
              <th>Chi ph√≠ Combo</th>
              <th>S·ªë ti·ªÅn ho√†n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="table-container" id="tiktokAffTableContainer" style="margin-top:30px;">
        <h2>B·∫£ng D·ªØ Li·ªáu AFF Tiktok</h2>
        <table id="tiktokAffTable">
          <thead>
            <tr>
              <th>T√™n nh√† s√°ng t·∫°o</th>
              <th>Lo·∫°i n·ªôi dung</th>
              <th>SKU ng∆∞·ªùi b√°n</th>
              <th>C∆° s·ªü hoa h·ªìng ∆∞·ªõc t√≠nh</th>
              <th>Thanh to√°n hoa h·ªìng ti√™u chu·∫©n ∆∞·ªõc t√≠nh</th>
              <th>Thanh to√°n hoa h·ªìng Qu·∫£ng c√°o c·ª≠a h√†ng ∆∞·ªõc t√≠nh</th>
              <th>Chi ph√≠ AFF</th>
              <th>Tr·∫°ng th√°i ƒë∆°n h√†ng</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="dashboardAffTiktokSection" style="display:none; margin-top:30px;">
        <h1>Dashboard Affiliate Tiktok</h1>
        <div id="dashboardAffTiktokSummaryCards" style="display:flex;gap:20px;margin-bottom:30px;">
          <div class="summary-card" style="background:#007bff;color:white;padding:20px;border-radius:10px;flex:1;display:flex;align-items:center;gap:10px;">
            <span style="font-size:2em;">üí∞</span>
            <div>
              <div style="font-size:1.2em;font-weight:bold;">T·ªïng GMV</div>
              <div id="dashboardAffTiktokTotalGMV" style="font-size:1.5em;">0‚Ç´</div>
            </div>
          </div>
          <div class="summary-card" style="background:#ff9800;color:white;padding:20px;border-radius:10px;flex:1;display:flex;align-items:center;gap:10px;">
            <span style="font-size:2em;">üí∏</span>
            <div>
              <div style="font-size:1.2em;font-weight:bold;">T·ªïng AFF Cost</div>
              <div id="dashboardAffTiktokTotalAffCost" style="font-size:1.5em;">0‚Ç´</div>
            </div>
          </div>
          <div class="summary-card" style="background:#ffc107;color:#333;padding:20px;border-radius:10px;flex:1;display:flex;align-items:center;gap:10px;">
            <span style="font-size:2em;">üì¶</span>
            <div>
              <div style="font-size:1.2em;font-weight:bold;">S·ªë ƒë∆°n h√†ng</div>
              <div id="dashboardAffTiktokTotalOrders" style="font-size:1.5em;">0</div>
            </div>
          </div>
          <div class="summary-card" style="background:#f44336;color:white;padding:20px;border-radius:10px;flex:1;display:flex;align-items:center;gap:10px;">
            <span style="font-size:2em;">‚ùå</span>
            <div>
              <div style="font-size:1.2em;font-weight:bold;">T·ª∑ l·ªá hu·ª∑ ƒë∆°n</div>
              <div id="dashboardAffTiktokCancelRate" style="font-size:1.5em;">0%</div>
            </div>
          </div>
          <div class="summary-card" style="background:#9c27b0;color:white;padding:20px;border-radius:10px;flex:1;display:flex;align-items:center;gap:10px;">
            <span style="font-size:2em;">‚öñÔ∏è</span>
            <div>
              <div style="font-size:1.2em;font-weight:bold;">T·ª∑ l·ªá AFF/GMV</div>
              <div id="dashboardAffTiktokAffGmvRate" style="font-size:1.5em;">0%</div>
            </div>
          </div>
        </div>
        <div class="table-container" id="dashboardAffTiktokSummaryTableContainer" style="margin-top:30px;">
          <h2>B·∫£ng t·ªïng h·ª£p theo nh√† s√°ng t·∫°o</h2>
          <table id="dashboardAffTiktokSummaryTable">
            <thead>
              <tr>
                <th>Nh√† s√°ng t·∫°o</th>
                <th>T·ªïng GMV</th>
                <th>T·ªïng AFF cost</th>
                <th>S·ªë ƒë∆°n</th>
                <th>% hu·ª∑</th>
                <th>T·ª∑ l·ªá AFF/GMV</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

  </main>

  <!-- Toast messages container -->
  <div id="toastContainer"></div>

<script>
  // --- Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu ƒë∆°n h√†ng ---
  // L∆∞u t·∫•t c·∫£ ƒë∆°n h√†ng ƒë√£ import, key: m√£ ƒë∆°n h√†ng, value: ƒë·ªëi t∆∞·ª£ng d·ªØ li·ªáu
  const dataOrders = new Map();
  // L∆∞u chi ph√≠ FLsale t·∫°m th·ªùi tr∆∞·ªõc khi l∆∞u
  const flSaleCosts = new Map();

  // C√°c tr·∫°ng th√°i h·ª£p l·ªá (ƒë∆°n th·∫≠t v√† kh√¥ng b·ªã ho√†n tr·∫£)
  const validOrderStatuses = [
    "Ch·ªù giao h√†ng",
    "ƒê√£ giao",
    "ƒê√£ nh·∫≠n ƒë∆∞·ª£c h√†ng",
    "ƒêang giao",
    "Ho√†n th√†nh"
  ];
  // Regex tr·∫°ng th√°i ƒë·∫∑c bi·ªát: ch·ªâ c·∫ßn ch·ª©a ƒëo·∫°n n√†y l√† h·ª£p l·ªá
  const regexConfirmedReceived = /Ng∆∞·ªùi mua x√°c nh·∫≠n ƒë√£ nh·∫≠n ƒë∆∞·ª£c h√†ng, tuy nhi√™n Ng∆∞·ªùi mua v·∫´n c√≥ th·ªÉ g·ª≠i y√™u c·∫ßu Tr·∫£ h√†ng\/Ho√†n ti·ªÅn/;

  // Tr·∫°ng th√°i tr·∫£ h√†ng/ho√†n ti·ªÅn lo·∫°i b·ªè
  const rejectReturnStatuses = [
    "ƒê√£ Ch·∫•p Thu·∫≠n Y√™u C·∫ßu",
    "ƒê√£ gi·∫£i quy·∫øt khi·∫øu n·∫°i",
    "Ho√†n t·∫•t tr·∫£ h√†ng",
    "Y√™u c·∫ßu ch·ªù x·ª≠ l√Ω"
  ];

  // H√†m hi·ªÉn th·ªã toast message
  function showToast(message, type = "success") {
    const container = document.getElementById("toastContainer");
    const toast = document.createElement("div");
    toast.classList.add("toast");
    if(type === "error") toast.classList.add("error");
    toast.innerHTML = `
      <span>${message}</span>
      <span class="close-btn" title="ƒê√≥ng">&times;</span>
    `;
    container.appendChild(toast);

    // ƒê√≥ng khi click n√∫t close
    toast.querySelector(".close-btn").addEventListener("click", () => {
      container.removeChild(toast);
    });

    // T·ª± ·∫©n sau 3s
    setTimeout(() => {
      if (container.contains(toast)) {
        container.removeChild(toast);
      }
    }, 3000);
  }

  // X·ª≠ l√Ω import file excel
  document.getElementById("importBtn").addEventListener("click", () => {
    // Kh√¥ng x√≥a d·ªØ li·ªáu c≈© ƒë·ªÉ c√≥ th·ªÉ update/ghi ƒë√® theo m√£ ƒë∆°n h√†ng
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      showToast("Vui l√≤ng ch·ªçn file Excel ƒë·ªÉ import!", "error");
      return;
    }

    const shop = document.getElementById("shopSelect").value;
    const loaiDon = document.getElementById("loaiDonSelect").value;

    const file = fileInput.files[0];

    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:"array"});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});

        let newCount = 0;
        let updateCount = 0;

        // Duy·ªát d·ªØ li·ªáu file, x·ª≠ l√Ω theo y√™u c·∫ßu
        for (const row of jsonData) {
          // L·∫•y c√°c tr∆∞·ªùng d·ªØ li·ªáu c·∫ßn thi·∫øt
          const maDonHang = String(row["M√£ ƒë∆°n h√†ng"] || "").trim();
          if (!maDonHang) continue; // B·ªè d√≤ng kh√¥ng c√≥ m√£ ƒë∆°n

          // L·∫•y d·ªØ li·ªáu tr·∫°ng th√°i, ki·ªÉu chu·ªói
          const trangThai = String(row["Tr·∫°ng Th√°i ƒê∆°n H√†ng"] || "").trim();
          const trangThaiTraHangHoanTien = String(row["Tr·∫°ng th√°i Tr·∫£ h√†ng/Ho√†n ti·ªÅn"] || "").trim();

          // T√≠nh doanh s·ªë ƒë∆°n h√†ng theo c√¥ng th·ª©c
          let tongGiaTri = parseFloat(row["T·ªïng gi√° tr·ªã ƒë∆°n h√†ng (VND)"] || 0);
          let maGiamGiaShopee = parseFloat(row["M√£ gi·∫£m gi√° c·ªßa Shopee"] || 0);
          let giamGiaComboShopee = parseFloat(row["Gi·∫£m gi√° t·ª´ combo Shopee"] || 0);
          let shopeeXuHoan = parseFloat(row["Shopee Xu ƒë∆∞∆°Ã£c hoaÃÄn"] || 0);
          let doanhSo = loaiDon === "ƒê∆°n ·∫£o" ? 0 : (tongGiaTri + maGiamGiaShopee + giamGiaComboShopee + shopeeXuHoan * 100);

          // X√ìA ƒêI ƒêI·ªÄU KI·ªÜN N√ÄY:
          // if (["ƒê√£ Ch·∫•p Thu·∫≠n Y√™u C·∫ßu", "Y√™u c·∫ßu ch·ªù x·ª≠ l√Ω", "ƒê√£ gi·∫£i quy·∫øt khi·∫øu n·∫°i"].includes(trangThaiTraHangHoanTien)) {
          //   doanhSo = 0;
          // }

          const maVanDon = String(row["M√£ v·∫≠n ƒë∆°n"] || "").trim();
          const sku = String(row["SKU ph√¢n lo·∫°i h√†ng"] || "");
          let comboCost = getBundledProductCost(sku);

          // ƒê·ªëi v·ªõi ƒë∆°n ·∫£o, comboCost = 0
          if (loaiDon === "ƒê∆°n ·∫£o") {
            comboCost = 0;
          }

          // L·∫•y gi√° ∆∞u ƒë√£i tr·ª±c ti·∫øp t·ª´ c·ªôt "GiaÃÅ ∆∞u ƒëaÃÉi" trong file excel
          let giaUuDai = row["GiaÃÅ ∆∞u ƒëaÃÉi"];

          // L·∫•y th√™m c√°c tr∆∞·ªùng c·∫ßn thi·∫øt cho t√≠nh to√°n chi ph√≠
          let maGiamGiaShop = parseFloat(row["M√£ gi·∫£m gi√° c·ªßa Shop"] || 0);
          let giamGiaComboShop = parseFloat(row["Gi·∫£m gi√° t·ª´ combo c·ªßa Shop"] || 0);

          // ƒê·ªëi v·ªõi ƒë∆°n ·∫£o, c√°c chi ph√≠ s·∫Ω ƒë∆∞·ª£c set = 0
          if (loaiDon === "ƒê∆°n ·∫£o") {
            maGiamGiaShop = 0;
            giamGiaComboShop = 0;
          }

          // H√†m l·∫•y gi√° tr·ªã c·ªôt b·∫•t k·ªÉ hoa th∆∞·ªùng, d·∫•u c√°ch
          function getColValue(row, ...possibleNames) {
            for (const name of possibleNames) {
              for (const key in row) {
                if (key.replace(/\s+/g, '').toLowerCase() === name.replace(/\s+/g, '').toLowerCase()) {
                  return row[key];
                }
              }
            }
            return 0;
          }

          // L·∫•y c√°c ph√≠ t·ª´ Excel (linh ho·∫°t t√™n c·ªôt)
          let phiCoDinh = parseFloat(getColValue(row, "Ph√≠ c·ªë ƒë·ªãnh", "c·ªë ƒë·ªãnh") || 0);
          let phiDichVu = parseFloat(getColValue(row, "Ph√≠ d·ªãch v·ª•", "Ph√≠ D·ªãch V·ª•") || 0);
          let phiThanhToan = parseFloat(getColValue(row, "Ph√≠ thanh to√°n") || 0);

          // Lu√¥n ghi ƒë√® d·ªØ li·ªáu theo m√£ ƒë∆°n h√†ng
          dataOrders.set(maDonHang, {
            shop,
            maDonHang,
            maVanDon,
            loaiDon,
            trangThai,
            trangThaiTraHangHoanTien,
            doanhSo,
            comboCost,
            giaUuDai,
            maGiamGiaShop,
            giamGiaComboShop,
            maGiamGiaShopee,
            giamGiaComboShopee,
            phiCoDinh,
            phiDichVu,
            phiThanhToan
          });
          newCount++;
        }

        renderTables();
        showToast(`Import th√†nh c√¥ng: ${newCount} ƒë∆°n m·ªõi (lo·∫°i b·ªè ${jsonData.length - newCount} ƒë∆°n tr√πng)`, "success");
        // Reset file input ƒë·ªÉ c√≥ th·ªÉ import l·∫°i file gi·ªëng ho·∫∑c kh√°c
        fileInput.value = "";

      } catch (err) {
        console.error(err);
        showToast("L·ªói khi ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra file v√† th·ª≠ l·∫°i.", "error");
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // Bi·∫øn l∆∞u d·ªØ li·ªáu AFF
  let affOrders = [];

  // X·ª≠ l√Ω import file AFF
  document.getElementById("importAffBtn").addEventListener("click", () => {
    const affFileInput = document.getElementById("affFileInput");
    if (!affFileInput.files.length) {
      showToast("Vui l√≤ng ch·ªçn file AFF ƒë·ªÉ import!", "error");
      return;
    }
    const shop = document.getElementById("shopSelect").value;
    const file = affFileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:"array"});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
        // Map ƒë·ªÉ c·ªông d·ªìn chi ph√≠ v√† ghi ƒë√® d·ªØ li·ªáu m·ªõi nh·∫•t cho m·ªói m√£ ƒë∆°n h√†ng
        const affOrderMap = new Map();
        for (const row of jsonData) {
          // L·∫•y c√°c tr∆∞·ªùng c·∫ßn thi·∫øt
          const maDonHang = String(row["M√£ ƒë∆°n h√†ng"] || "").trim();
          if (!maDonHang) continue; // B·ªè d√≤ng kh√¥ng c√≥ m√£ ƒë∆°n

          const trangThaiDonHang = String(row["Tr·∫°ng th√°i ƒë∆°n h√†ng"] || "").trim();
          const trangThaiGianLan = String(row["Tr·∫°ng th√°i gian l·∫≠n"] || "").trim();
          const taiKhoanTTLK = String(row["T√†i kho·∫£n Ti·∫øp th·ªã li√™n k·∫øt"] || "").trim();
          const mcnDuocLienKet = String(row["MCN ƒë∆∞·ª£c li√™n k·∫øt"] || "").trim();
          const kenh = String(row["K√™nh"] || "").trim();
          const chiPhiRaw = row["Chi ph√≠(‚Ç´)"];
          const trangThaiKhauTru = String(row["Tr·∫°ng th√°i kh·∫•u tr·ª´"] || "").trim();

          // T√≠nh chi ph√≠
          let chiPhi = 0;
          if (["Tr·ª´ ti·ªÅn ch·ªù x·ª≠ l√Ω", "ƒê√£ kh·∫•u tr·ª´"].includes(trangThaiKhauTru)) {
            chiPhi = typeof chiPhiRaw === 'number' ? chiPhiRaw : (typeof chiPhiRaw === 'string' && chiPhiRaw !== '' && !isNaN(Number(chiPhiRaw.replace(/,/g, '')))) ? Number(chiPhiRaw.replace(/,/g, '')) : 0;
          }

          // N·∫øu m√£ ƒë∆°n ƒë√£ t·ªìn t·∫°i th√¨ c·ªông d·ªìn chi ph√≠ v√† ghi ƒë√® th√¥ng tin m·ªõi nh·∫•t
          if (affOrderMap.has(maDonHang)) {
            const existingOrder = affOrderMap.get(maDonHang);
            existingOrder.chiPhi += chiPhi;
            // Ghi ƒë√® th√¥ng tin kh√°c b·∫±ng d·ªØ li·ªáu m·ªõi nh·∫•t
            existingOrder.trangThaiDonHang = trangThaiDonHang;
            existingOrder.trangThaiGianLan = trangThaiGianLan;
            existingOrder.taiKhoanTTLK = taiKhoanTTLK;
            existingOrder.mcnDuocLienKet = mcnDuocLienKet;
            existingOrder.kenh = kenh;
            existingOrder.trangThaiKhauTru = trangThaiKhauTru;
          } else {
            // N·∫øu ch∆∞a c√≥ th√¨ t·∫°o m·ªõi
            affOrderMap.set(maDonHang, {
              shop,
              maDonHang,
              trangThaiDonHang,
              trangThaiGianLan,
              taiKhoanTTLK,
              mcnDuocLienKet,
              kenh,
              chiPhi,
              trangThaiKhauTru
            });
          }
        }
        affOrders = Array.from(affOrderMap.values());
        renderAffTable();
        showToast(`Import AFF th√†nh c√¥ng: ${affOrders.length} d√≤ng`, "success");
        affFileInput.value = "";
      } catch (err) {
        console.error(err);
        showToast("L·ªói khi ƒë·ªçc file AFF. Vui l√≤ng ki·ªÉm tra file v√† th·ª≠ l·∫°i.", "error");
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // --- Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu Tiktok ---
  const tiktokOrders = [];

  // X·ª≠ l√Ω import file excel Tiktok
  document.getElementById("importBtnTiktok").addEventListener("click", () => {
    const fileInput = document.getElementById("fileInputTiktok");
    if (!fileInput.files.length) {
      showToast("Vui l√≤ng ch·ªçn file Excel Tiktok ƒë·ªÉ import!", "error");
      return;
    }
    const shop = document.getElementById("shopSelectTiktok").value;
    const loaiDon = document.getElementById("loaiDonSelectTiktok").value;
    const file = fileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:"array"});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
        // X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU C≈® TR∆Ø·ªöC KHI IMPORT
        tiktokOrders.length = 0;
        // Kh√¥ng ki·ªÉm tra tr√πng, kh√¥ng ghi ƒë√®, push t·∫•t c·∫£ c√°c d√≤ng v√†o m·∫£ng
        for (const row of jsonData) {
          const orderId = String(row["Order ID"] || "").trim();
          if (!orderId) continue;
          const orderStatus = String(row["Order Status"] || "").trim();
          const returnType = String(row["Cancelation/Return Type"] || "").trim();
          const sku = String(row["Seller SKU"] || "");
          const productName = String(row["Product Name"] || "");
          const price = parseFloat(row["SKU Subtotal After Discount"] || 0);
          const tiktokDiscount = parseFloat(row["SKU Platform Discount"] || 0);
          const shopDiscount = parseFloat(row["SKU Seller Discount"] || 0);
          const refundAmount = parseFloat(row["Order Refund Amount"] || 0);
          let doanhSo = 0;
          if (loaiDon === "ƒê∆°n th·∫≠t") {
            doanhSo = price + tiktokDiscount;
          }
          if (loaiDon === "ƒê∆°n ·∫£o") {
            doanhSo = 0;
          }
          let comboCost = sku ? getBundledProductCostTiktok(sku) : 0;
          if (loaiDon === "ƒê∆°n ·∫£o") {
            comboCost = 0;
          }
          const newOrder = {
            shop,
            orderId,
            orderStatus,
            returnType,
            sku,
            sellerSku: sku,
            productName,
            price,
            tiktokDiscount,
            shopDiscount,
            doanhSo,
            refundAmount,
            loaiDon,
            comboCost
          };
          tiktokOrders.push(newOrder);
        }
        // Sau khi c·∫≠p nh·∫≠t d·ªØ li·ªáu, lu√¥n render l·∫°i b·∫£ng t·ªïng h·ª£p v√† chi ti·∫øt
        renderTiktokTable();
        showToast(`Import th√†nh c√¥ng: ${jsonData.length} d√≤ng s·∫£n ph·∫©m Tiktok!`, "success");
        fileInput.value = "";
      } catch (err) {
        console.error(err);
        showToast("L·ªói khi ƒë·ªçc file Excel Tiktok. Vui l√≤ng ki·ªÉm tra file v√† th·ª≠ l·∫°i.", "error");
      }
    };
    reader.readAsArrayBuffer(file);
  });

  const formatVND = v => {
    let num = typeof v === 'number' ? v : (typeof v === 'string' && v !== '' && !isNaN(Number(v.replace(/,/g, '')))) ? Number(v.replace(/,/g, '')) : null;
    return num !== null ? num.toLocaleString('vi-VN', {style: 'currency', currency: 'VND', minimumFractionDigits: 0}) : v;
  };

  // H√†m format s·ªë th√†nh VNƒê kh√¥ng c√≥ k√Ω hi·ªáu ti·ªÅn t·ªá
  const formatNumberVND = v => {
    let num = typeof v === 'number' ? v : (typeof v === 'string' && v !== '' && !isNaN(Number(v.replace(/,/g, '')))) ? Number(v.replace(/,/g, '')) : null;
    return num !== null ? num.toLocaleString('vi-VN') : v;
  };

  // ƒê·ªïi filter Doanh s·ªë th√†nh filter Gi√° ∆∞u ƒë√£i
  // Format cho filter dropdown
  function renderGiaUuDaiFilter() {
    const filter = document.getElementById("giaUuDaiFilter");
    // L∆∞u l·∫°i gi√° tr·ªã filter hi·ªán t·∫°i
    const currentValue = filter.value;
    const values = Array.from(dataOrders.values()).map(o => o.giaUuDai);
    const unique = Array.from(new Set(values)).filter(v => v !== undefined && v !== '').sort((a,b) => Number(a)-Number(b));
    filter.innerHTML = '<option value="">T·∫•t c·∫£</option>' + unique.map(v => `<option value="${v}">${formatVND(v)}</option>`).join("");
    // Gi·ªØ l·∫°i gi√° tr·ªã filter hi·ªán t·∫°i n·∫øu c√≤n t·ªìn t·∫°i, n·∫øu kh√¥ng th√¨ v·ªÅ "T·∫•t c·∫£"
    if (currentValue && unique.includes(currentValue)) {
      filter.value = currentValue;
    } else {
      filter.value = "";
    }
  }

  // Bi·∫øn l∆∞u filter t·ª´ng c·ªôt
  const ordersTableColFilters = {
    shop: '',
    maDonHang: '',
    maVanDon: '',
    loaiDon: '',
    trangThai: '',
    trangThaiTraHangHoanTien: '',
    doanhSo: '',
    flSaleCost: '',
    comboCost: '',
    giaUuDai: ''
  };

  // H√†m t√≠nh to√°n & render b·∫£ng
  function renderTables() {
    const summary = {}; // t·ªïng h·ª£p theo shop

    // T√≠nh to√°n theo t·ª´ng ƒë∆°n h√†ng
    for (const order of dataOrders.values()) {
      if (!summary[order.shop]) {
        summary[order.shop] = {
          tongDoanhSoDonThat: 0,
          doanhSoThucTe: 0,
          doanhSoHuy: 0,
          doanhSoHoan: 0
        };
      }
      const s = summary[order.shop];

      // ƒê∆°n th·∫≠t m·ªõi t√≠nh doanh s·ªë t·ªïng
      if (order.loaiDon === "ƒê∆°n th·∫≠t") {
        s.tongDoanhSoDonThat += order.doanhSo;
      }

      // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h·ª£p l·ªá cho doanh s·ªë th·ª±c t·∫ø
      const trangThaiHopLe = validOrderStatuses.includes(order.trangThai) || regexConfirmedReceived.test(order.trangThai);
      const isTraHangHoanTien = rejectReturnStatuses.includes(order.trangThaiTraHangHoanTien);

      // ƒê·∫£m b·∫£o c√°c ƒë∆°n c√≥ tr·∫°ng th√°i kh·ªõp regex c≈©ng ƒë∆∞·ª£c t√≠nh doanh s·ªë th·ª±c t·∫ø n·∫øu kh√¥ng b·ªã ho√†n tr·∫£
      if (order.loaiDon !== "ƒê∆°n ·∫£o" && trangThaiHopLe && !isTraHangHoanTien) {
        s.doanhSoThucTe += order.doanhSo;
      }

      // --- S·ª¨A ƒêO·∫†N N√ÄY: Ph√¢n bi·ªát Shopee v√† Tiktok khi t√≠nh doanh s·ªë h·ªßy/ho√†n ---
      if (order.loaiDon === "ƒê∆°n th·∫≠t") {
        // N·∫øu l√† ƒë∆°n Shopee (kh√¥ng c√≥ orderStatus/returnType)
        if (typeof order.orderStatus === 'undefined' && typeof order.returnType === 'undefined') {
          // ƒê∆°n H·ªßy: tr·∫°ng th√°i ch·ª©a "h·ªßy"
          if ((order.trangThai || "").toLowerCase().includes("h·ªßy")) {
            s.doanhSoHuy += order.doanhSo;
          }
          // ƒê∆°n Ho√†n: tr·∫°ng th√°i tr·∫£ h√†ng/ho√†n ti·ªÅn n·∫±m trong rejectReturnStatuses
          else if (rejectReturnStatuses.includes(order.trangThaiTraHangHoanTien)) {
            s.doanhSoHoan += order.doanhSo;
          }
        } else {
          // Tiktok logic c≈© gi·ªØ nguy√™n
          if (normalizeStatus(order.orderStatus).includes("h·ªßy")) {
            s.doanhSoHuy += order.doanhSo;
          } else if (order.returnType === "Return/Refund") {
            s.doanhSoHoan += order.doanhSo;
          }
          if (order.refundAmount > 0 && !normalizeStatus(order.orderStatus).includes("h·ªßy")) {
            s.doanhSoHoan += order.refundAmount;
          }
        }
      }
    }

    // Render b·∫£ng T·ªïng h·ª£p
    const tbodySummary = document.querySelector("#summaryTable tbody");
    tbodySummary.innerHTML = "";
    let totalSummary = {
      tongDoanhSoDonThat: 0,
      doanhSoThucTe: 0,
      doanhSoHoanHuy: 0,
      doanhSoHuy: 0,
      doanhSoHoan: 0
    };

    for (const shop in summary) {
      const s = summary[shop];
      const doanhSoHoanHuy = s.tongDoanhSoDonThat - s.doanhSoThucTe;
      const tyLeHuy = s.tongDoanhSoDonThat > 0 ? ((s.doanhSoHuy / s.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
      const tyLeHoan = s.tongDoanhSoDonThat > 0 ? ((s.doanhSoHoan / s.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";

      // C·ªông v√†o t·ªïng
      totalSummary.tongDoanhSoDonThat += s.tongDoanhSoDonThat;
      totalSummary.doanhSoThucTe += s.doanhSoThucTe;
      totalSummary.doanhSoHoanHuy += doanhSoHoanHuy;
      totalSummary.doanhSoHuy += s.doanhSoHuy;
      totalSummary.doanhSoHoan += s.doanhSoHoan;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${shop}</td>
        <td>${formatVND(s.tongDoanhSoDonThat)}</td>
        <td>${formatVND(s.doanhSoThucTe)}</td>
        <td>${formatVND(doanhSoHoanHuy)}</td>
        <td>${formatVND(s.doanhSoHuy)}</td>
        <td>${formatVND(s.doanhSoHoan)}</td>
        <td>${tyLeHuy}%</td>
        <td>${tyLeHoan}%</td>
      `;
      tbodySummary.appendChild(tr);
    }

    // Th√™m d√≤ng t·ªïng
    const trTotalSummary = document.createElement("tr");
    trTotalSummary.style.fontWeight = "bold";
    trTotalSummary.style.backgroundColor = "#f0f0f0";
    const tyLeHuyTotal = totalSummary.tongDoanhSoDonThat > 0 ? ((totalSummary.doanhSoHuy / totalSummary.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
    const tyLeHoanTotal = totalSummary.tongDoanhSoDonThat > 0 ? ((totalSummary.doanhSoHoan / totalSummary.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
    trTotalSummary.innerHTML = `
      <td><strong>T·ªîNG</strong></td>
      <td><strong>${formatVND(totalSummary.tongDoanhSoDonThat)}</strong></td>
      <td><strong>${formatVND(totalSummary.doanhSoThucTe)}</strong></td>
      <td><strong>${formatVND(totalSummary.doanhSoHoanHuy)}</strong></td>
      <td><strong>${formatVND(totalSummary.doanhSoHuy)}</strong></td>
      <td><strong>${formatVND(totalSummary.doanhSoHoan)}</strong></td>
      <td><strong>${tyLeHuyTotal}%</strong></td>
      <td><strong>${tyLeHoanTotal}%</strong></td>
    `;
    tbodySummary.appendChild(trTotalSummary);

    // Render b·∫£ng Danh s√°ch ƒë∆°n h√†ng
    const tbodyOrders = document.querySelector("#ordersTable tbody");
    tbodyOrders.innerHTML = "";
    const giaUuDaiFilter = document.getElementById("giaUuDaiFilter").value;
    for (const order of dataOrders.values()) {
      if (giaUuDaiFilter && order.giaUuDai != giaUuDaiFilter) continue;
      // L·ªçc theo t·ª´ng c·ªôt
      if (ordersTableColFilters.shop && !order.shop.toLowerCase().includes(ordersTableColFilters.shop)) continue;
      if (ordersTableColFilters.maDonHang && !order.maDonHang.toLowerCase().includes(ordersTableColFilters.maDonHang)) continue;
      if (ordersTableColFilters.maVanDon && !order.maVanDon.toLowerCase().includes(ordersTableColFilters.maVanDon)) continue;
      if (ordersTableColFilters.loaiDon && !order.loaiDon.toLowerCase().includes(ordersTableColFilters.loaiDon)) continue;
      if (ordersTableColFilters.trangThai && !order.trangThai.toLowerCase().includes(ordersTableColFilters.trangThai)) continue;
      if (ordersTableColFilters.trangThaiTraHangHoanTien && !order.trangThaiTraHangHoanTien.toLowerCase().includes(ordersTableColFilters.trangThaiTraHangHoanTien)) continue;
      if (ordersTableColFilters.doanhSo && !order.doanhSo.toString().includes(ordersTableColFilters.doanhSo)) continue;
      if (ordersTableColFilters.flSaleCost && !(typeof order.flSaleCost !== 'undefined' && order.flSaleCost.toString().includes(ordersTableColFilters.flSaleCost))) continue;
      if (ordersTableColFilters.comboCost && !(typeof order.comboCost !== 'undefined' && order.comboCost.toString().includes(ordersTableColFilters.comboCost))) continue;
      if (ordersTableColFilters.giaUuDai && !(typeof order.giaUuDai !== 'undefined' && order.giaUuDai.toString().includes(ordersTableColFilters.giaUuDai))) continue;
      const formatNumber = v => formatNumberVND(v);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="order-checkbox" data-madon="${order.maDonHang}"></td>
        <td>${order.shop}</td>
        <td>${order.maDonHang}</td>
        <td>${order.maVanDon}</td>
        <td>${order.loaiDon}</td>
        <td>${order.trangThai}</td>
        <td>${order.trangThaiTraHangHoanTien}</td>
        <td>${order.giaUuDai !== undefined ? formatVND(order.giaUuDai) : ''}</td>
        <td>${formatVND(order.doanhSo)}</td>
        <td><input type="number" min="0" class="flsale-input" data-madon="${order.maDonHang}" value="${typeof order.flSaleCost !== 'undefined' ? order.flSaleCost : ''}" style="width:90px;"></td>
        <td>${order.comboCost ? formatVND(order.comboCost) : ''}</td>
      `;
      tbodyOrders.appendChild(tr);
    }
    renderGiaUuDaiFilter();
    renderCostTables();
  }

  // H√†m render b·∫£ng AFF
function renderAffTable() {
  const tbody = document.querySelector("#affTable tbody");
  tbody.innerHTML = "";
  for (const order of affOrders) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${order.shop}</td>
      <td>${order.maDonHang}</td>
      <td>${order.trangThaiDonHang}</td>
      <td>${order.trangThaiGianLan}</td>
      <td>${order.taiKhoanTTLK}</td>
      <td>${order.mcnDuocLienKet}</td>
      <td>${order.kenh}</td>
      <td>${formatVND(order.chiPhi)}</td>
      <td>${order.trangThaiKhauTru}</td>
    `;
    tbody.appendChild(tr);
  }
  renderCostTables();
}

  // H√†m render b·∫£ng chi ph√≠ t·ªïng h·ª£p v√† chi ph√≠ s√†n
function renderCostTables() {
  // T√≠nh to√°n chi ph√≠ t·ªïng h·ª£p theo shop
  const costSummary = {};
  const platformCost = {};

  // Debug: ƒê·∫øm t·ªïng s·ªë ƒë∆°n h√†ng
  const totalOrders = dataOrders.size;
  console.log(`T·ªïng s·ªë ƒë∆°n h√†ng trong dataOrders: ${totalOrders}`);

  // Kh·ªüi t·∫°o d·ªØ li·ªáu cho t·ª´ng shop
  for (const order of dataOrders.values()) {
    if (!costSummary[order.shop]) {
      costSummary[order.shop] = {
        maGiamGiaShop: 0,
        giamGiaComboShop: 0,
        giamGiaComboGhep: 0,
        chiPhiFLsale: 0,
        phiCoDinh: 0,
        phiDichVu: 0,
        phiThanhToan: 0,
        totalOrders: 0,
        validOrders: 0
      };
    }
    if (!platformCost[order.shop]) {
      platformCost[order.shop] = {
        soDonThucTe: 0,
        totalOrders: 0,
        phiCoDinh: 0,
        phiDichVu: 0,
        phiThanhToan: 0
      };
    }

    // ƒê·∫øm t·ªïng s·ªë ƒë∆°n h√†ng theo shop
    costSummary[order.shop].totalOrders++;
    platformCost[order.shop].totalOrders++;

    // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
    const trangThaiHopLe = validOrderStatuses.includes(order.trangThai) || regexConfirmedReceived.test(order.trangThai);
    const isTraHangHoanTien = rejectReturnStatuses.includes(order.trangThaiTraHangHoanTien);
    const isDonAo = order.loaiDon === "ƒê∆°n ·∫£o";
    
    // Ki·ªÉm tra ƒë∆°n h√†ng c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
    const isOrderRejected = isDonAo || !trangThaiHopLe || isTraHangHoanTien;
    
    // Ch·ªâ c·ªông d·ªìn c√°c chi ph√≠ n·∫øu ƒë∆°n h√†ng KH√îNG b·ªã lo·∫°i b·ªè
    if (!isOrderRejected) {
      costSummary[order.shop].maGiamGiaShop += order.maGiamGiaShop || 0;
      costSummary[order.shop].giamGiaComboShop += order.giamGiaComboShop || 0;
      costSummary[order.shop].giamGiaComboGhep += order.comboCost || 0;
      costSummary[order.shop].chiPhiFLsale += order.flSaleCost || 0;
      
      // C·ªông d·ªìn c√°c ph√≠ t·ª´ Excel
      costSummary[order.shop].phiCoDinh += order.phiCoDinh || 0;
      costSummary[order.shop].phiDichVu += order.phiDichVu || 0;
      costSummary[order.shop].phiThanhToan += order.phiThanhToan || 0;
      platformCost[order.shop].phiCoDinh += order.phiCoDinh || 0;
      platformCost[order.shop].phiDichVu += order.phiDichVu || 0;
      platformCost[order.shop].phiThanhToan += order.phiThanhToan || 0;
    }

    // ƒê·∫øm s·ªë ƒë∆°n h√†ng th·ª±c t·∫ø (ƒë∆°n h√†ng ƒë√°p ·ª©ng ti√™u ch√≠ doanh s·ªë th·ª±c t·∫ø)

    // Debug: In ra th√¥ng tin ƒë∆°n h√†ng kh√¥ng h·ª£p l·ªá
    if (order.loaiDon === "ƒê∆°n ·∫£o") {
      console.log(`ƒê∆°n ·∫£o b·ªã lo·∫°i: ${order.maDonHang} - ${order.shop}`);
    } else if (!trangThaiHopLe) {
      console.log(`Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá: ${order.maDonHang} - ${order.trangThai} - ${order.shop}`);
    } else if (isTraHangHoanTien) {
      console.log(`B·ªã ho√†n tr·∫£: ${order.maDonHang} - ${order.trangThaiTraHangHoanTien} - ${order.shop}`);
    } else {
      costSummary[order.shop].validOrders++;
    }

    if (order.loaiDon !== "ƒê∆°n ·∫£o" && trangThaiHopLe && !isTraHangHoanTien) {
      platformCost[order.shop].soDonThucTe++;
    }
  }

  // Debug: In ra th·ªëng k√™ theo shop
  for (const shop in platformCost) {
    console.log(`${shop}: T·ªïng ${platformCost[shop].totalOrders} ƒë∆°n, Th·ª±c t·∫ø ${platformCost[shop].soDonThucTe} ƒë∆°n`);
  }

  // C·ªông chi ph√≠ AFF theo shop (ch·ªâ cho c√°c ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè)
  for (const affOrder of affOrders) {
    if (!costSummary[affOrder.shop]) {
      costSummary[affOrder.shop] = {
        maGiamGiaShop: 0,
        giamGiaComboShop: 0,
        giamGiaComboGhep: 0,
        chiPhiFLsale: 0,
        chiPhiAFF: 0,
        phiCoDinh: 0,
        phiDichVu: 0,
        phiThanhToan: 0,
        totalOrders: 0,
        validOrders: 0
      };
    }
    
    // T√¨m ƒë∆°n h√†ng t∆∞∆°ng ·ª©ng trong dataOrders ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i
    const correspondingOrder = dataOrders.get(affOrder.maDonHang);
    if (correspondingOrder) {
      const trangThaiHopLe = validOrderStatuses.includes(correspondingOrder.trangThai) || regexConfirmedReceived.test(correspondingOrder.trangThai);
      const isTraHangHoanTien = rejectReturnStatuses.includes(correspondingOrder.trangThaiTraHangHoanTien);
      const isDonAo = correspondingOrder.loaiDon === "ƒê∆°n ·∫£o";
      const isOrderRejected = isDonAo || !trangThaiHopLe || isTraHangHoanTien;
      
      // Ch·ªâ c·ªông chi ph√≠ AFF n·∫øu ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè
      if (!isOrderRejected) {
        costSummary[affOrder.shop].chiPhiAFF = (costSummary[affOrder.shop].chiPhiAFF || 0) + affOrder.chiPhi;
      }
    }
  }

  // Render b·∫£ng chi ph√≠ t·ªïng h·ª£p
  const tbodyCostSummary = document.querySelector("#costSummaryTable tbody");
  tbodyCostSummary.innerHTML = "";
  let totalCostSummary = {
    maGiamGiaShop: 0,
    giamGiaComboShop: 0,
    giamGiaComboGhep: 0,
    chiPhiFLsale: 0,
    chiPhiAFF: 0,
    tongChiPhi: 0
  };

  for (const shop in costSummary) {
    const cost = costSummary[shop];
    const tongChiPhi = cost.maGiamGiaShop + cost.giamGiaComboShop + cost.giamGiaComboGhep + cost.chiPhiFLsale + cost.chiPhiAFF;

    // C·ªông v√†o t·ªïng
    totalCostSummary.maGiamGiaShop += cost.maGiamGiaShop;
    totalCostSummary.giamGiaComboShop += cost.giamGiaComboShop;
    totalCostSummary.giamGiaComboGhep += cost.giamGiaComboGhep;
    totalCostSummary.chiPhiFLsale += cost.chiPhiFLsale;
    totalCostSummary.chiPhiAFF += cost.chiPhiAFF;
    totalCostSummary.tongChiPhi += tongChiPhi;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${shop}</td>
      <td>${formatVND(cost.maGiamGiaShop)}</td>
      <td>${formatVND(cost.giamGiaComboShop)}</td>
      <td>${formatVND(cost.giamGiaComboGhep)}</td>
      <td>${formatVND(cost.chiPhiFLsale)}</td>
      <td>${formatVND(cost.chiPhiAFF)}</td>
      <td>${formatVND(tongChiPhi)}</td>
    `;
    tbodyCostSummary.appendChild(tr);
  }

  // Th√™m d√≤ng t·ªïng
  const trTotal = document.createElement("tr");
  trTotal.style.fontWeight = "bold";
  trTotal.style.backgroundColor = "#f0f0f0";
  trTotal.innerHTML = `
    <td><strong>T·ªîNG</strong></td>
    <td><strong>${formatVND(totalCostSummary.maGiamGiaShop)}</strong></td>
    <td><strong>${formatVND(totalCostSummary.giamGiaComboShop)}</strong></td>
    <td><strong>${formatVND(totalCostSummary.giamGiaComboGhep)}</strong></td>
    <td><strong>${formatVND(totalCostSummary.chiPhiFLsale)}</strong></td>
    <td><strong>${formatVND(totalCostSummary.chiPhiAFF)}</strong></td>
    <td><strong>${formatVND(totalCostSummary.tongChiPhi)}</strong></td>
  `;
  tbodyCostSummary.appendChild(trTotal);

  // Render b·∫£ng chi ph√≠ s√†n
  const tbodyPlatformCost = document.querySelector("#platformCostTable tbody");
  tbodyPlatformCost.innerHTML = "";
  let totalPlatformCost = {
    soDonThucTe: 0,
    phiCoDinh: 0,
    phiDichVu: 0,
    phiThanhToan: 0,
    phiPiShip: 0,
    tongChiPhiSan: 0
  };

  for (const shop in platformCost) {
    const cost = platformCost[shop];
    const phiPiShip = 1650 * cost.totalOrders;  // Ph√≠ Pi Ship = 1650 √ó t·ªïng s·ªë ƒë∆°n h√†ng c·ªßa shop
    const tongChiPhiSan = cost.phiCoDinh + cost.phiDichVu + cost.phiThanhToan + phiPiShip;

    // C·ªông v√†o t·ªïng
    totalPlatformCost.soDonThucTe += cost.soDonThucTe;
    totalPlatformCost.phiCoDinh += cost.phiCoDinh;
    totalPlatformCost.phiDichVu += cost.phiDichVu;
    totalPlatformCost.phiThanhToan += cost.phiThanhToan;
    totalPlatformCost.phiPiShip += phiPiShip;
    totalPlatformCost.tongChiPhiSan += tongChiPhiSan;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${shop}</td>
      <td>${cost.soDonThucTe} (T·ªïng: ${cost.totalOrders})</td>
      <td>${formatVND(cost.phiCoDinh)}</td>
      <td>${formatVND(cost.phiDichVu)}</td>
      <td>${formatVND(cost.phiThanhToan)}</td>
      <td>${formatVND(phiPiShip)}</td>
      <td>${formatVND(tongChiPhiSan)}</td>
    `;
    tbodyPlatformCost.appendChild(tr);
  }

  // Th√™m d√≤ng t·ªïng
  const trTotalPlatform = document.createElement("tr");
  trTotalPlatform.style.fontWeight = "bold";
  trTotalPlatform.style.backgroundColor = "#f0f0f0";
  trTotalPlatform.innerHTML = `
    <td><strong>T·ªîNG</strong></td>
    <td><strong>${totalPlatformCost.soDonThucTe}</strong></td>
    <td><strong>${formatVND(totalPlatformCost.phiCoDinh)}</strong></td>
    <td><strong>${formatVND(totalPlatformCost.phiDichVu)}</strong></td>
    <td><strong>${formatVND(totalPlatformCost.phiThanhToan)}</strong></td>
    <td><strong>${formatVND(totalPlatformCost.phiPiShip)}</strong></td>
    <td><strong>${formatVND(totalPlatformCost.tongChiPhiSan)}</strong></td>
  `;
  tbodyPlatformCost.appendChild(trTotalPlatform);
}

  // H√†m render b·∫£ng Tiktok
  function renderTiktokTable() {
    const table = document.getElementById("tiktokSummaryTable");
    if (!table) return;
    const tbody = table.querySelector("tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (tiktokOrders.length === 0) {
      table.style.display = "none";
      renderTiktokTotalSummaryTable();
      renderTiktokCostSummaryTable();
      return;
    }
    table.style.display = "table";
    // ƒê·∫øm s·ªë l·∫ßn xu·∫•t hi·ªán c·ªßa m·ªói Order ID
    const orderIdCount = {};
    for (const order of tiktokOrders) {
      orderIdCount[order.orderId] = (orderIdCount[order.orderId] || 0) + 1;
    }
    for (const order of tiktokOrders) {
      const tr = document.createElement("tr");
      if (orderIdCount[order.orderId] > 1) {
        tr.classList.add("duplicate-order");
      }
      tr.innerHTML = `
        <td>${order.shop}</td>
        <td>${order.orderId}</td>
        <td>${order.sellerSku}</td>
        <td>${order.orderStatus}</td>
        <td>${order.returnType}</td>
        <td>${formatVND(order.price)}</td>
        <td>${formatVND(order.tiktokDiscount)}</td>
        <td>${formatVND(order.shopDiscount)}</td>
        <td>${formatVND(order.doanhSo)}</td>
        <td>${order.comboCost ? formatVND(order.comboCost) : ''}</td>
        <td>${
          (order.refundAmount > 0 && !normalizeStatus(order.orderStatus).includes('h·ªßy'))
            ? formatVND(order.refundAmount)
            : ''
        }</td>
      `;
      tbody.appendChild(tr);
    }
    // T·ªïng h·ª£p theo shop
    renderTiktokTotalSummaryTable();
    renderTiktokCostSummaryTable();
  }

  // H√†m render b·∫£ng t·ªïng h·ª£p doanh s·ªë Tiktok
  function renderTiktokTotalSummaryTable() {
    const table = document.getElementById("tiktokTotalSummaryTable");
    if (!table) return;
    const tbody = table.querySelector("tbody");
    if (!tbody) return;
    tbody.innerHTML = "";
    if (tiktokOrders.length === 0) return;
    // T·ªïng h·ª£p theo shop
    const summary = {};
    for (const order of tiktokOrders) {
      if (!summary[order.shop]) {
        summary[order.shop] = {
          tongDoanhSoDonThat: 0,
          doanhSoThucTe: 0,
          doanhSoHuy: 0,
          doanhSoHoan: 0
        };
      }
      const s = summary[order.shop];
      // T·ªïng doanh s·ªë ƒë∆°n th·∫≠t
      if (order.loaiDon === "ƒê∆°n th·∫≠t") {
        s.tongDoanhSoDonThat += order.doanhSo;
      }
      // ƒê∆°n h·ª£p l·ªá ƒë·ªÉ t√≠nh doanh s·ªë th·ª±c t·∫ø
      const trangThaiHopLe = ["ƒê√£ ho√†n t·∫•t", "ƒê√£ v·∫≠n chuy·ªÉn"].includes(order.orderStatus);
      const isReturn = order.returnType === "Return/Refund";
      if (order.loaiDon === "ƒê∆°n th·∫≠t" && trangThaiHopLe && !isReturn) {
        s.doanhSoThucTe += order.doanhSo;
      }
      // ƒê∆°n H·ªßy
      if (order.loaiDon === "ƒê∆°n th·∫≠t" && normalizeStatus(order.orderStatus).includes("h·ªßy")) {
        s.doanhSoHuy += order.doanhSo;
      }
      // Doanh s·ªë ƒê∆°n Ho√†n: ch·ªâ c·ªông SUM c·ªßa Order Refund Amount
      if (
        order.loaiDon === "ƒê∆°n th·∫≠t" &&
        order.refundAmount > 0 &&
        !normalizeStatus(order.orderStatus).includes("h·ªßy")
      ) {
        s.doanhSoHoan += order.refundAmount;
      }
    }
    // Render t·ª´ng shop
    let total = {
      tongDoanhSoDonThat: 0,
      doanhSoThucTe: 0,
      doanhSoHoanHuy: 0,
      doanhSoHuy: 0,
      doanhSoHoan: 0
    };
    for (const shop in summary) {
      const s = summary[shop];
      const doanhSoHoanHuy = s.doanhSoHuy + s.doanhSoHoan;
      const tyLeHuy = s.tongDoanhSoDonThat > 0 ? ((s.doanhSoHuy / s.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
      const tyLeHoan = s.tongDoanhSoDonThat > 0 ? ((s.doanhSoHoan / s.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
      total.tongDoanhSoDonThat += s.tongDoanhSoDonThat;
      total.doanhSoThucTe += s.doanhSoThucTe;
      total.doanhSoHoanHuy += doanhSoHoanHuy;
      total.doanhSoHuy += s.doanhSoHuy;
      total.doanhSoHoan += s.doanhSoHoan;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${shop}</td>
        <td>${formatVND(s.tongDoanhSoDonThat)}</td>
        <td>${formatVND(s.doanhSoThucTe)}</td>
        <td>${formatVND(doanhSoHoanHuy)}</td>
        <td>${formatVND(s.doanhSoHuy)}</td>
        <td>${formatVND(s.doanhSoHoan)}</td>
        <td>${tyLeHuy}%</td>
        <td>${tyLeHoan}%</td>
      `;
      tbody.appendChild(tr);
    }
    // D√≤ng t·ªïng c·ªông
    const tyLeHuyTotal = total.tongDoanhSoDonThat > 0 ? ((total.doanhSoHuy / total.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
    const tyLeHoanTotal = total.tongDoanhSoDonThat > 0 ? ((total.doanhSoHoan / total.tongDoanhSoDonThat) * 100).toFixed(2) : "0.00";
    const doanhSoHoanHuyTotal = total.doanhSoHuy + total.doanhSoHoan;
    const trTotal = document.createElement("tr");
    trTotal.style.fontWeight = "bold";
    trTotal.style.backgroundColor = "#f0f0f0";
    trTotal.innerHTML = `
      <td><strong>T·ªîNG</strong></td>
      <td><strong>${formatVND(total.tongDoanhSoDonThat)}</strong></td>
      <td><strong>${formatVND(total.doanhSoThucTe)}</strong></td>
      <td><strong>${formatVND(doanhSoHoanHuyTotal)}</strong></td>
      <td><strong>${formatVND(total.doanhSoHuy)}</strong></td>
      <td><strong>${formatVND(total.doanhSoHoan)}</strong></td>
      <td><strong>${tyLeHuyTotal}%</strong></td>
      <td><strong>${tyLeHoanTotal}%</strong></td>
    `;
    tbody.appendChild(trTotal);
  }

  // X·ª≠ l√Ω ·∫©n/hi·ªán menu
  const sidebar = document.getElementById("sidebar");
  const toggleBtn = document.getElementById("toggleSidebar");
  toggleBtn.addEventListener("click", () => {
    sidebar.classList.toggle("collapsed");
    toggleBtn.textContent = sidebar.classList.contains("collapsed") ? "‚Øà" : "‚Øá";
  });

  // Chuy·ªÉn ƒë·ªïi gi·ªØa Shopee, Tiktok, Dashboard
  const btnShopee = document.getElementById("btnTinhDoanhSoShopee");
  const btnTiktok = document.getElementById("btnTinhDoanhThuTiktok");
  const btnDashboardAffTiktok = document.getElementById("btnDashboardAffTiktok");
  const sectionShopee = document.getElementById("tinhDoanhSoShopeeSection");
  const sectionTiktok = document.getElementById("tinhDoanhThuTiktokSection");
  const sectionDashboardAffTiktok = document.getElementById("dashboardAffTiktokSection");
  btnShopee.addEventListener("click", () => {
    btnShopee.classList.add("active");
    btnTiktok.classList.remove("active");
    btnDashboardAffTiktok.classList.remove("active");
    sectionShopee.style.display = "block";
    sectionTiktok.style.display = "none";
    sectionDashboardAffTiktok.style.display = "none";
  });
  btnTiktok.addEventListener("click", () => {
    btnTiktok.classList.add("active");
    btnShopee.classList.remove("active");
    btnDashboardAffTiktok.classList.remove("active");
    sectionShopee.style.display = "none";
    sectionTiktok.style.display = "block";
    sectionDashboardAffTiktok.style.display = "none";
    renderTiktokTable(); // <-- Th√™m d√≤ng n√†y!
  });
  btnDashboardAffTiktok.addEventListener("click", () => {
    btnDashboardAffTiktok.classList.add("active");
    btnShopee.classList.remove("active");
    btnTiktok.classList.remove("active");
    sectionShopee.style.display = "none";
    sectionTiktok.style.display = "none";
    sectionDashboardAffTiktok.style.display = "block";
    renderDashboardAffTiktok();
  });

  // H√†m render summary cards cho Dashboard AFF Tiktok
  function renderDashboardAffTiktok() {
    // G·ªôp theo nh√† s√°ng t·∫°o
    const summaryByCreator = {};
    let totalGMV = 0, totalAffCost = 0, totalOrders = 0, cancelOrders = 0;
    for (const order of tiktokAffOrders) {
      const creator = order.tenNhaSangTao || "(Kh√¥ng r√µ)";
      if (!summaryByCreator[creator]) {
        summaryByCreator[creator] = {
          gmv: 0,
          affCost: 0,
          orders: 0,
          cancel: 0
        };
      }
      summaryByCreator[creator].gmv += order.coSoHoaHongUocTinh || 0;
      summaryByCreator[creator].affCost += order.thanhToanTieuChuanUocTinh || 0;
      summaryByCreator[creator].orders++;
      if (normalizeStatus(order.trangThaiDonHang).includes("h·ªßy")) {
        summaryByCreator[creator].cancel++;
        cancelOrders++;
      }
      totalGMV += order.coSoHoaHongUocTinh || 0;
      totalAffCost += order.thanhToanTieuChuanUocTinh || 0;
      totalOrders++;
    }
    // Render summary cards
    document.getElementById("dashboardAffTiktokTotalGMV").textContent = formatVND(totalGMV);
    document.getElementById("dashboardAffTiktokTotalAffCost").textContent = formatVND(totalAffCost);
    document.getElementById("dashboardAffTiktokTotalOrders").textContent = totalOrders;
    document.getElementById("dashboardAffTiktokCancelRate").textContent = totalOrders > 0 ? ((cancelOrders / totalOrders * 100).toFixed(2) + "%") : "0%";
    document.getElementById("dashboardAffTiktokAffGmvRate").textContent = totalGMV > 0 ? ((totalAffCost / totalGMV * 100).toFixed(2) + "%") : "0%";

    // Render b·∫£ng t·ªïng h·ª£p theo nh√† s√°ng t·∫°o
    const tbody = document.querySelector("#dashboardAffTiktokSummaryTable tbody");
    tbody.innerHTML = "";
    for (const creator in summaryByCreator) {
      const s = summaryByCreator[creator];
      const cancelRate = s.orders > 0 ? ((s.cancel / s.orders) * 100).toFixed(2) + "%" : "0%";
      const affGmvRate = s.gmv > 0 ? ((s.affCost / s.gmv) * 100).toFixed(2) + "%" : "0%";
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${creator}</td>
        <td>${formatVND(s.gmv)}</td>
        <td>${formatVND(s.affCost)}</td>
        <td>${s.orders}</td>
        <td>${cancelRate}</td>
        <td>${affGmvRate}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  // ·∫®n/hi·ªán b·∫£ng t·ªïng h·ª£p
  const summaryTableContainer = document.getElementById("summaryTableContainer");
  const toggleSummaryTable = document.getElementById("toggleSummaryTable");
  toggleSummaryTable.addEventListener("click", () => {
    if (summaryTableContainer.style.display === "none") {
      summaryTableContainer.style.display = "block";
      toggleSummaryTable.textContent = "‚ñº";
    } else {
      summaryTableContainer.style.display = "none";
      toggleSummaryTable.textContent = "‚ñ≤";
    }
  });

  // ·∫®n/hi·ªán b·∫£ng ƒë∆°n h√†ng
  const ordersTableContainer = document.getElementById("ordersTableContainer");
  const ordersTableFilterBar = document.getElementById("ordersTableFilterBar");
  const toggleOrdersTable = document.getElementById("toggleOrdersTable");
  toggleOrdersTable.addEventListener("click", () => {
    if (ordersTableContainer.style.display === "none") {
      ordersTableContainer.style.display = "block";
      ordersTableFilterBar.style.display = "block";
      toggleOrdersTable.textContent = "‚ñº";
    } else {
      ordersTableContainer.style.display = "none";
      ordersTableFilterBar.style.display = "none";
      toggleOrdersTable.textContent = "‚ñ≤";
    }
  });

  // ·∫®n/hi·ªán b·∫£ng chi ph√≠ s√†n
  const platformCostTableContainer = document.getElementById("platformCostTableContainer");
  const togglePlatformCostTable = document.getElementById("togglePlatformCostTable");
  togglePlatformCostTable.addEventListener("click", () => {
    if (platformCostTableContainer.style.display === "none") {
      platformCostTableContainer.style.display = "block";
      togglePlatformCostTable.textContent = "‚ñº";
    } else {
      platformCostTableContainer.style.display = "none";
      togglePlatformCostTable.textContent = "‚ñ≤";
    }
  });

  // ·∫®n/hi·ªán b·∫£ng chi ph√≠ t·ªïng h·ª£p
  const costSummaryTableContainer = document.getElementById("costSummaryTableContainer");
  const toggleCostSummaryTable = document.getElementById("toggleCostSummaryTable");
  toggleCostSummaryTable.addEventListener("click", () => {
    if (costSummaryTableContainer.style.display === "none") {
      costSummaryTableContainer.style.display = "block";
      toggleCostSummaryTable.textContent = "‚ñº";
    } else {
      costSummaryTableContainer.style.display = "none";
      toggleCostSummaryTable.textContent = "‚ñ≤";
    }
  });

  // S·ª± ki·ªán filter Gi√° ∆∞u ƒë√£i
  document.getElementById("giaUuDaiFilter").addEventListener("change", renderTables);

  // S·ª± ki·ªán nh·∫≠p Chi ph√≠ FLsale
  document.getElementById("ordersTable").addEventListener("input", function(e) {
    if (e.target.classList.contains("flsale-input")) {
      const maDon = e.target.getAttribute("data-madon");
      flSaleCosts.set(maDon, Number(e.target.value));
    }
  });

  // S·ª± ki·ªán l∆∞u Chi ph√≠ FLsale
  document.getElementById("saveFlSaleBtn").addEventListener("click", function() {
    let count = 0;
    for (const [maDon, cost] of flSaleCosts.entries()) {
      if (dataOrders.has(maDon)) {
        dataOrders.get(maDon).flSaleCost = cost;
        count++;
      }
    }
    flSaleCosts.clear();
    renderTables();
    showToast(`ƒê√£ l∆∞u ${count} Chi ph√≠ FLsale!`, "success");
  });

  // S·ª± ki·ªán √°p d·ª•ng h√†ng lo·∫°t
  document.getElementById("applyBatchFlSaleBtn").addEventListener("click", function() {
    const value = Number(document.getElementById("batchFlSaleInput").value);
    if (isNaN(value) || value < 0) {
      showToast("Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá cho Chi ph√≠ FLsale!", "error");
      return;
    }
    let count = 0;
    document.querySelectorAll(".order-checkbox:checked").forEach(cb => {
      const maDon = cb.getAttribute("data-madon");
      if (dataOrders.has(maDon)) {
        dataOrders.get(maDon).flSaleCost = value;
        count++;
      }
    });
    renderTables();
    showToast(`ƒê√£ √°p d·ª•ng cho ${count} ƒë∆°n h√†ng!`, "success");
  });

  // S·ª± ki·ªán t√¨m ki·∫øm t·ª´ng c·ªôt
  document.getElementById("ordersTableSearchRow").addEventListener("input", function(e) {
    if (e.target.classList.contains("search-col")) {
      const col = e.target.getAttribute("data-col");
      ordersTableColFilters[col] = e.target.value.trim().toLowerCase();
      renderTables();
    }
  });

  // H√†m l·∫•y chi ph√≠ combo gh√©p t·ª´ SKU ph√¢n lo·∫°i h√†ng
  function getBundledProductCost(sku) {
    if (!sku) return 0;
    // T√¨m pattern COMBO/.../s·ªë
    const comboMatch = sku.match(/COMBO[\/\w-]*\/(\d+)$/i);
    if (comboMatch && comboMatch[1]) {
      return Number(comboMatch[1]);
    }
    // T√¨m pattern COMBO/.../s·ªë ·ªü cu·ªëi
    const lastNum = sku.match(/\/(\d+)$/);
    if (lastNum) return Number(lastNum[1]);
    return 0;
  }

  // S·ª± ki·ªán checkbox t·∫•t c·∫£
  document.getElementById("selectAllOrders").addEventListener("change", function(e) {
    const checked = e.target.checked;
    document.querySelectorAll(".order-checkbox").forEach(cb => { cb.checked = checked; });
  });

  // S·ª± ki·ªán debug
  document.getElementById("debugBtn").addEventListener("click", function() {
    console.log("=== DEBUG INFO ===");
    console.log(`T·ªïng s·ªë ƒë∆°n h√†ng: ${dataOrders.size}`);
    console.log(`T·ªïng s·ªë ƒë∆°n AFF: ${affOrders.length}`);

    // Th·ªëng k√™ theo shop
    const shopStats = {};
    for (const order of dataOrders.values()) {
      if (!shopStats[order.shop]) {
        shopStats[order.shop] = {
          total: 0,
          donThat: 0,
          donAo: 0,
          trangThaiHopLe: 0,
          biHoanTra: 0
        };
      }
      shopStats[order.shop].total++;

      if (order.loaiDon === "ƒê∆°n th·∫≠t") {
        shopStats[order.shop].donThat++;
      } else {
        shopStats[order.shop].donAo++;
      }

      const trangThaiHopLe = validOrderStatuses.includes(order.trangThai) || regexConfirmedReceived.test(order.trangThai);
      const isTraHangHoanTien = rejectReturnStatuses.includes(order.trangThaiTraHangHoanTien);

      if (trangThaiHopLe) {
        shopStats[order.shop].trangThaiHopLe++;
      }
      if (isTraHangHoanTien) {
        shopStats[order.shop].biHoanTra++;
      }
    }

    console.log("Th·ªëng k√™ theo shop:");
    for (const shop in shopStats) {
      const stats = shopStats[shop];
      console.log(`${shop}: T·ªïng ${stats.total}, ƒê∆°n th·∫≠t ${stats.donThat}, ƒê∆°n ·∫£o ${stats.donAo}, Tr·∫°ng th√°i h·ª£p l·ªá ${stats.trangThaiHopLe}, B·ªã ho√†n tr·∫£ ${stats.biHoanTra}`);
    }

    // Hi·ªÉn th·ªã toast v·ªõi th√¥ng tin t·ªïng quan
    const totalOrders = dataOrders.size;
    const totalAff = affOrders.length;
    showToast(`Debug: ${totalOrders} ƒë∆°n h√†ng, ${totalAff} ƒë∆°n AFF. Xem Console ƒë·ªÉ bi·∫øt chi ti·∫øt.`, "success");
  });

  function normalizeStatus(str) {
    return (str || '').toLowerCase().replace(/ƒë√£ h[·ªßy|u·ª∑]/g, 'ƒë√£ h·ªßy').trim();
  }

  // H√†m l·∫•y chi ph√≠ combo gh√©p t·ª´ Seller SKU (gi·ªëng Shopee)
  function getBundledProductCostTiktok(sku) {
    if (!sku) return 0;

    // Ki·ªÉm tra n·∫øu Seller SKU ch·ª©a t·ª´ COMBO
    if (sku.includes("COMBO")) {
      // L·∫•y s·ªë ti·ªÅn d·ª±a v√†o d·ªØ li·ªáu l·∫•y n·∫±m b√™n tay ph·∫£i c·ªßa d·∫•u / cu·ªëi c√πng
      const lastSlashIndex = sku.lastIndexOf('/');
      if (lastSlashIndex !== -1 && lastSlashIndex < sku.length - 1) {
        const valueAfterLastSlash = sku.substring(lastSlashIndex + 1);
        if (!isNaN(valueAfterLastSlash)) {
          return Number(valueAfterLastSlash);
        }
      }
    }

    return 0;
  }

  // --- Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu AFF Tiktok ---
  let tiktokAffOrders = [];

  // X·ª≠ l√Ω import file AFF Tiktok
  document.getElementById("importAffBtnTiktok").addEventListener("click", () => {
    const affFileInput = document.getElementById("affFileInputTiktok");
    if (!affFileInput.files.length) {
      showToast("Vui l√≤ng ch·ªçn file AFF Tiktok ƒë·ªÉ import!", "error");
      return;
    }
    const file = affFileInput.files[0];
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type:"array"});
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});
        tiktokAffOrders = [];
        for (const row of jsonData) {
          const tenNhaSangTao = String(row["T√™n ng∆∞·ªùi d√πng nh√† s√°ng t·∫°o"] || row["T√™n nh√† s√°ng t·∫°o"] || "").trim();
          const loaiNoiDung = String(row["Lo·∫°i n·ªôi dung"] || "").trim();
          const sellerSku = String(row["Seller SKU"] || row["SKU ng∆∞·ªùi b√°n"] || row["SellerSku"] || "").trim();
          const coSoHoaHongUocTinh = parseFloat(row["C∆° s·ªü hoa h·ªìng ∆∞·ªõc t√≠nh"] || 0);
          const thanhToanTieuChuanUocTinh = parseFloat(row["Thanh to√°n hoa h·ªìng ti√™u chu·∫©n ∆∞·ªõc t√≠nh"] || 0);
          const thanhToanQCCTUocTinh = parseFloat(row["Thanh to√°n hoa h·ªìng Qu·∫£ng c√°o c·ª≠a h√†ng ∆∞·ªõc t√≠nh"] || 0);
          const trangThaiDonHang = String(row["Tr·∫°ng th√°i ƒë∆°n h√†ng"] || "").trim();
          // Chi ph√≠ AFF
          let chiPhiAFF = 0;
          if (!normalizeStatus(trangThaiDonHang).includes("h·ªßy")) {
            chiPhiAFF = thanhToanTieuChuanUocTinh + thanhToanQCCTUocTinh;
          }
          tiktokAffOrders.push({
            tenNhaSangTao,
            loaiNoiDung,
            sellerSku,
            coSoHoaHongUocTinh,
            thanhToanTieuChuanUocTinh,
            thanhToanQCCTUocTinh,
            chiPhiAFF,
            trangThaiDonHang
          });
        }
        renderTiktokAffTable();
        showToast(`Import AFF Tiktok th√†nh c√¥ng: ${tiktokAffOrders.length} d√≤ng`, "success");
        affFileInput.value = "";
        // G·ªçi l·∫°i renderTiktokCostSummaryTable ƒë·ªÉ c·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p chi ph√≠ Tiktok
        renderTiktokCostSummaryTable();
      } catch (err) {
        console.error(err);
        showToast("L·ªói khi ƒë·ªçc file AFF Tiktok. Vui l√≤ng ki·ªÉm tra file v√† th·ª≠ l·∫°i.", "error");
      }
    };
    reader.readAsArrayBuffer(file);
  });

  // H√†m render b·∫£ng AFF Tiktok
  function renderTiktokAffTable() {
    const tbody = document.querySelector("#tiktokAffTable tbody");
    tbody.innerHTML = "";
    for (const order of tiktokAffOrders) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${order.tenNhaSangTao}</td>
        <td>${order.loaiNoiDung}</td>
        <td>${order.sellerSku}</td>
        <td>${formatVND(order.coSoHoaHongUocTinh)}</td>
        <td>${formatVND(order.thanhToanTieuChuanUocTinh)}</td>
        <td>${formatVND(order.thanhToanQCCTUocTinh)}</td>
        <td>${formatVND(order.chiPhiAFF)}</td>
        <td>${order.trangThaiDonHang}</td>
      `;
      tbody.appendChild(tr);
    }
    renderDashboardAffTiktok();
  }

  // Dashboard Affiliate Tiktok
  function renderTiktokAffDashboard() {
    const tbody = document.querySelector("#tiktokAffDashboardTable tbody");
    tbody.innerHTML = "";
    for (const order of tiktokAffOrders) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${order.tenNhaSangTao}</td>
        <td>${order.loaiNoiDung}</td>
        <td>${order.sellerSku}</td>
        <td>${formatVND(order.coSoHoaHongUocTinh)}</td>
        <td>${formatVND(order.thanhToanTieuChuanUocTinh)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderTiktokCostSummaryTable() {
    const table = document.getElementById("tiktokCostSummaryTable");
    if (!table) return;
    const tbody = table.querySelector("tbody");
    if (!tbody) return;
    tbody.innerHTML = "";

    // Ki·ªÉm tra xem ƒë√£ import d·ªØ li·ªáu ch∆∞a
    // N·∫øu ch∆∞a import d·ªØ li·ªáu th√¨ kh√¥ng hi·ªÉn th·ªã th√¥ng tin shop
    if (tiktokOrders.length === 0 && tiktokAffOrders.length === 0) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td colspan="3" style="text-align: center;"><em>Ch∆∞a c√≥ d·ªØ li·ªáu. Vui l√≤ng import d·ªØ li·ªáu tr∆∞·ªõc.</em></td>
      `;
      tbody.appendChild(tr);
      return;
    }

    // L·∫•y shop ƒëang ch·ªçn, n·∫øu kh√¥ng c√≥ d·ªØ li·ªáu th√¨ m·∫∑c ƒë·ªãnh ch·ªçn shop ƒë·∫ßu ti√™n
    let selectedShop = document.getElementById("shopSelectTiktok").value;
    if (!selectedShop && document.getElementById("shopSelectTiktok").options.length > 0) {
      selectedShop = document.getElementById("shopSelectTiktok").options[0].value;
      document.getElementById("shopSelectTiktok").value = selectedShop;
    }
    // T·ªïng chi ph√≠ Combo gh√©p c·ªßa shop ƒëang ch·ªçn (ch·ªâ cho ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè)
    let totalCombo = 0;
    for (const order of tiktokOrders) {
      if (order.shop === selectedShop) {
        // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
        const trangThaiHopLe = ["ƒê√£ ho√†n t·∫•t", "ƒê√£ v·∫≠n chuy·ªÉn"].includes(order.orderStatus);
        const isReturn = order.returnType === "Return/Refund";
        const isDonAo = order.loaiDon === "ƒê∆°n ·∫£o";
        const isOrderRejected = isDonAo || !trangThaiHopLe || isReturn;
        
        // Ch·ªâ c·ªông chi ph√≠ combo n·∫øu ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè
        if (!isOrderRejected) {
          totalCombo += order.comboCost || 0;
        }
      }
    }
    // T·ªïng chi ph√≠ AFF c·ªßa shop ƒëang ch·ªçn (ch·ªâ cho ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè)
    let totalAff = 0;
    for (const aff of tiktokAffOrders) {
      // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng AFF c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
      const isAffOrderRejected = normalizeStatus(aff.trangThaiDonHang).includes("h·ªßy");
      
      if (!isAffOrderRejected) {
        if (aff.tenNhaSangTao && aff.shop && aff.shop === selectedShop) {
          totalAff += aff.chiPhiAFF || 0;
        } else if (!aff.shop && selectedShop) {
          // N·∫øu d·ªØ li·ªáu AFF kh√¥ng c√≥ tr∆∞·ªùng shop, v·∫´n c·ªông h·∫øt (gi·ªØ logic c≈©)
          totalAff += aff.chiPhiAFF || 0;
        }
      }
    }
    // Hi·ªÉn th·ªã 1 d√≤ng cho shop ƒëang ch·ªçn
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><strong>${selectedShop}</strong></td>
      <td><strong>${formatVND(totalCombo)}</strong></td>
      <td><strong>${formatVND(totalAff)}</strong></td>
    `;
    tbody.appendChild(tr);
    // Th√™m d√≤ng t·ªïng c·ªông cho t·∫•t c·∫£ c√°c shop (ch·ªâ cho ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè)
    let grandTotalCombo = 0;
    for (const order of tiktokOrders) {
      // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
      const trangThaiHopLe = ["ƒê√£ ho√†n t·∫•t", "ƒê√£ v·∫≠n chuy·ªÉn"].includes(order.orderStatus);
      const isReturn = order.returnType === "Return/Refund";
      const isDonAo = order.loaiDon === "ƒê∆°n ·∫£o";
      const isOrderRejected = isDonAo || !trangThaiHopLe || isReturn;
      
      // Ch·ªâ c·ªông chi ph√≠ combo n·∫øu ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè
      if (!isOrderRejected) {
        grandTotalCombo += order.comboCost || 0;
      }
    }
    let grandTotalAff = 0;
    for (const aff of tiktokAffOrders) {
      // Ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng AFF c√≥ b·ªã lo·∫°i b·ªè hay kh√¥ng
      const isAffOrderRejected = normalizeStatus(aff.trangThaiDonHang).includes("h·ªßy");
      
      // Ch·ªâ c·ªông chi ph√≠ AFF n·∫øu ƒë∆°n h√†ng kh√¥ng b·ªã lo·∫°i b·ªè
      if (!isAffOrderRejected) {
        grandTotalAff += aff.chiPhiAFF || 0;
      }
    }
    const trTotal = document.createElement("tr");
    trTotal.style.fontWeight = "bold";
    trTotal.style.backgroundColor = "#f0f0f0";
    trTotal.innerHTML = `
      <td><strong>T·ªîNG</strong></td>
      <td><strong>${formatVND(grandTotalCombo)}</strong></td>
      <td><strong>${formatVND(grandTotalAff)}</strong></td>
    `;
    tbody.appendChild(trTotal);
  }

  // G·ªçi l·∫°i renderTiktokCostSummaryTable khi thay ƒë·ªïi shop
  const shopSelectTiktok = document.getElementById("shopSelectTiktok");
  if (shopSelectTiktok) {
    shopSelectTiktok.addEventListener("change", function() {
      // Kh√¥ng render l·∫°i b·∫£ng chi ph√≠ t·ªïng h·ª£p khi ch·ªâ ch·ªçn shop
      // renderTiktokCostSummaryTable(); // D√≤ng n√†y b·ªã lo·∫°i b·ªè ƒë·ªÉ tr√°nh update kh√¥ng mong mu·ªën
    });
  }

</script>
</body>
</html>
